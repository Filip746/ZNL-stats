<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8" />
    <title>Filtriranje utakmica po klubovima</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #555;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        caption {
            font-size: 1.5em;
            margin: 10px 0;
            font-weight: bold;
        }
        label {
            font-weight: bold;
        }
        select, button {
            padding: 8px;
            font-size: 1em;
            margin: 5px 0;
        }
        #loading {
            text-align: center;
            font-style: italic;
            color: #555;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <label for="clubFilter">Filtriraj po klubu:</label>
    <select id="clubFilter" onchange="filterTable()">
        <option value="">--- Prikaži sve utakmice ---</option>
        <option value="ŠNK Mladost Varaždinske Toplice">ŠNK Mladost Varaždinske Toplice</option>
        <option value="ŠNK Mladost Šemovec">ŠNK Mladost Šemovec</option>
        <option value="NK Beretinec">NK Beretinec</option>
        <option value="NK Dubravka-Zagorac">NK Dubravka-Zagorac</option>
        <option value="ŠNK Mladost Sigetec Ludbreški">ŠNK Mladost Sigetec Ludbreški</option>
        <option value="ŠNK Drava">ŠNK Drava</option>
        <option value="ŠNK Zadrugar">ŠNK Zadrugar</option>
        <option value="NK Zelengaj">NK Zelengaj</option>
        <option value="NK Nova Ves">NK Nova Ves</option>
        <option value="NK Plitvica (S)">NK Plitvica (S)</option>
        <option value="NK Sloboda Tužno">NK Sloboda Tužno</option>
        <option value="NK Obreš">NK Obreš</option>
    </select>

    <button onclick="sortTable()">Sortiraj po broju gledatelja</button>

    <div id="loading">Učitavanje podataka...</div>

    <table id="matchesTable">
        <caption>Broj gledatelja po utakmici</caption>
        <thead>
            <tr>
                <th>Datum i vrijeme</th>
                <th>Utakmica</th>
                <th>Broj gledatelja</th>
            </tr>
        </thead>
        <tbody>
            <!-- Utakmice će biti dodane ovdje putem JavaScripta -->
        </tbody>
    </table>

    <div id="averageViewers" style="margin-top:20px; font-family: Arial, sans-serif; font-weight: bold;"></div>

    <script>
        // Popis CSV datoteka koje treba učitati
        const csvFiles = [
            'newround1.csv',
            'newround2.csv',
            'newround3.csv',
            'newround4.csv',
            'newround5.csv',
            'newround6.csv',
            'newround7.csv',
            'newround8.csv',
            'newround9.csv',
            'newround10.csv',
            'newround11.csv',
        ];

        // Mapiranje skraćenica iz CSV-a u puna imena klubova
        const clubNameMap = {
            'Mladost VT': 'ŠNK Mladost Varaždinske Toplice',
            'Semovec': 'ŠNK Mladost Šemovec',
            'Beretinec': 'NK Beretinec',
            'Dubravka': 'NK Dubravka-Zagorac',
            'Mladost SL': 'ŠNK Mladost Sigetec Ludbreški',
            'Drava': 'ŠNK Drava',
            'Zadrugar': 'ŠNK Zadrugar',
            'Zelengaj': 'NK Zelengaj',
            'Nova Ves': 'NK Nova Ves',
            'Plitvica': 'NK Plitvica (S)',
            'Sloboda': 'NK Sloboda Tužno',
            'Obres': 'NK Obreš'
        };

        // Funkcija za parsiranje CSV retka
        function parseCSVLine(line) {
            return line.split(';').map(field => field.trim());
        }

        // Funkcija za pretvaranje kratkog imena kluba u puno
        function getFullClubName(name) {
            return clubNameMap[name] || name;
        }

        // Funkcija za učitavanje svih CSV datoteka
        async function loadAllMatches() {
            const tbody = document.querySelector('#matchesTable tbody');
            tbody.innerHTML = ''; // Isprazni tablicu

            for (const file of csvFiles) {
                try {
                    const response = await fetch(file);
                    if (!response.ok) throw new Error(`Neuspješno učitavanje: ${file}`);
                    const text = await response.text();
                    const lines = text.trim().split('\n');

                    // Preskoči zaglavlje
                    for (let i = 1; i < lines.length; i++) {
                        const [homeTeam, awayTeam, homeScore, awayScore, dateOfMatch, attendance] = parseCSVLine(lines[i]);
                        const fullHome = getFullClubName(homeTeam);
                        const fullAway = getFullClubName(awayTeam);

                        const row = document.createElement('tr');

                        // Formatiranje datuma: pretvori "23.8.2025" u "23.08.2025"
                        const formattedDate = dateOfMatch.replace(/\b(\d)\.(\d)\./, '0$1.0$2.').replace(/\b(\d)\.(\d{2})\./, '0$1.$2.');

                        row.innerHTML = `
                            <td>${formattedDate} 16:00</td>
                            <td>${fullHome} - ${fullAway}</td>
                            <td>${attendance}</td>
                        `;
                        tbody.appendChild(row);
                    }
                } catch (error) {
                    console.error(error);
                }
            }

            document.getElementById('loading').style.display = 'none';
            filterTable(); // Ažuriraj prikaz nakon učitavanja
        }

        // Pozovi funkciju za učitavanje prilikom učitavanja stranice
        window.onload = loadAllMatches;

        // Filtriranje tablice po klubu
        function filterTable() {
            const filter = document.getElementById('clubFilter').value.toLowerCase();
            const tbody = document.querySelector('#matchesTable tbody');
            const trs = tbody.querySelectorAll('tr');

            // Prikaz svih utakmica koje sadrže odabrani klub
            trs.forEach(tr => {
                const matchText = tr.cells[1].textContent.toLowerCase();
                tr.style.display = filter === "" || matchText.includes(filter) ? "" : "none";
            });

            // Računanje prosjeka za sve klubske imena
            const clubs = Array.from(document.getElementById('clubFilter').options)
                .slice(1)
                .map(option => option.value);

            const averages = {};

            clubs.forEach(club => {
                let countMatches = 0;
                let sumViewers = 0;

                trs.forEach(tr => {
                    if (tr.style.display !== "none") {
                        const matchText = tr.cells[1].textContent;
                        const viewers = parseInt(tr.cells[2].textContent);
                        if (matchText.includes(club)) {
                            countMatches++;
                            sumViewers += viewers;
                        }
                    }
                });

                averages[club] = countMatches > 0 ? (sumViewers / countMatches).toFixed(1) : '-';
            });

            const averageDiv = document.getElementById('averageViewers');
            if (filter && filter !== "") {
                const clubName = clubs.find(c => c.toLowerCase() === filter) || filter;
                averageDiv.innerHTML = `Prosječan broj gledatelja za <strong>${clubName}</strong>: ${averages[clubName] || '-'}`;
            } else {
                let html = `<table border="1" cellpadding="5" style="border-collapse: collapse; margin-top: 10px;">`;
                html += `<thead><tr><th>Klub</th><th>Prosječan broj gledatelja</th></tr></thead><tbody>`;
                const averagesArray = clubs.map(club => [club, parseFloat(averages[club]) || 0]);
                averagesArray.sort((a, b) => b[1] - a[1]);
                averagesArray.forEach(([club, avg]) => {
                    const displayAvg = avg === 0 ? '-' : avg.toFixed(1);
                    html += `<tr><td>${club}</td><td>${displayAvg}</td></tr>`;
                });
                html += `</tbody></table>`;
                averageDiv.innerHTML = html;
            }
        }

        // Sortiranje tablice po broju gledatelja (silazno)
        function sortTable() {
            const tbody = document.querySelector('#matchesTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const aVal = parseInt(a.cells[2].textContent) || 0;
                const bVal = parseInt(b.cells[2].textContent) || 0;
                return bVal - aVal;
            });

            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
</body>
</html>
